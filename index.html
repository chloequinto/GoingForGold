<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script>
    <script src="p5.js"></script>
    <!-- <script scr="index.js"></script> -->
</head>

<body>

    <video id="video" src="/video/tennis_serving.mp4"></video>
    <canvas id="thecanvas" width="800" height="600"></canvas>
</body>

<script>
    //Variables
    var keypoints;
    var tStamp; //capture image and move it over and putting it in small canvas
    var minPartConfidence;

    function setup() {
        createCanvas(800, 600);
        background(10, 0, 0);
        tStamp = 0;
        minPartConfidence = 0.3;
    }
    video.addEventListener('loadeddata', function() {
        this.currentTime = tStamp;
        console.log(tStamp);
    });
    video.addEventListener('loadeddata', function() {
        var duration = video.duration;
        var tStamp = 0;
        var interval = setInterval(function() {
            video.currentTime = tStamp;
            generateThumbnail(tStamp);
            tStamp = tStamp + 1;
            if (tStamp > duration) clearInterval(interval); //tStamp is the duration of the video
        }, 200);
    });

    function generateThumbnail(tStamp) {
        var context = thecanvas.getContext('2d');
        context.drawImage(video, 0, 0, 800, 600);
        var dataURL = thecanvas.toDataURL();
        var img = document.createElement('img');
        img.setAttribute('src', dataURL);
        document.getElementById('thecanvas').appendChild(img);
        posenet.load().then(function(net) {
            const pose = net.estimateSinglePose(img, {
                flipHorizontal: true
            });
            return pose;
        }).then(function(pose) {
            console.log(pose);
            keypoints = pose.keypoints; //different x,y values; keypoint is array
            draw(); //calls per frame
        })
    }

    function draw() {
        background(0); //sets a black background
        for (var i = 0; i < keypoints.length; i++) { //array length 
            var keypoint = keypoints[i];
            if (keypoint.score > minPartConfidence) {
                if (i == posenet.partIds['leftWrist'] || i == posenet.partIds['rightWrist']) {
                    //P5 only starts after you call setup()
                    //reason why we wrote window.onload = setup()
                    fill(255, 0, 0);
                    rectMode(CENTER);
                    noStroke();
                    rect(keypoint.position.x, keypoint.position.y, 10, 10);
                } else {
                    //maybe instead of dots draw lines?
                    // fill(255, 255, 0);
                    fill(0, 255, 0);
                    noStroke();
                    ellipse(keypoint.position.x, keypoint.position.y, 10, 10); //draws the dot  
                }
                if (i == posenet.partIds['leftWrist']) {
                    var pointX = keypoint.position.x;
                    var pointY = keypoint.position.y;
                }
                if (i == posenet.partIds['leftElbow']) {
                    var ptX = keypoint.position.x;
                    var ptY = keypoint.position.y;
                }
                stroke(255);
                strokeWeight(4);
                line(pointX, pointY, ptX, ptY);
            }
        }
    }
    video.addEventListener('seeked', function() {
        generateThumbnail(tStamp);
        tStamp += 0.5;
        if (tStamp <= this.duration) {
            this.currentTime = tStamp;
        } else {
            // Do something idk 
        }
    });
    //onload call setup
    window.onload = setup;
</script>

</html>